select PF.REFERENCE as Account,
SS.NISS as SPN,
D.SERIAL_NUM as METER_NR,
DM.MARK_NAME as METER_BRAND,
PD.INSTALLATION_DATE as INSTAL_DATE,
PD.REMOVAL_DATE as REMOV_DATE,
(select top 1 Case
when DA.value = 'TIMOD00001' then 'Conventional'
ELSE 'Smart'
End
from GCGT_ME_DEVICE_ATTRIBUTE DA
where DA.ID_DEVICE = R.ID_DEVICE AND
DA.COD_MASTER_ATTRIBUTE = 'READMODE' )
as TYPE_MECHANISM,
CON.Name_type as USG_TYPE,
R.VALUE as READING,
SS.CTPT_FACTOR as BILL_COEF,
R.READING_DATE as READING_DATE,
( CASE when R.IND_ESTIMATE = 0 then 'Actual'
ELSE 'Estimated'
End )
as READING_TYPE,
ru.DESCRIPTION as EMPLOYER_READING_UNIT,
REA.NAME as EMPLOYEE_READER,
REA.ID_EMPLOYEE as EMPLOYEE_ID,
bill.BILL_NUMBER as BILL_ID,
(select top 1 R1.reading_date from gcgt_re_reading R1
WHERE R1.ID_DEVICE = R.ID_DEVICE AND R1.READING_TYPE = R.READING_TYPE and R1.IND_ESTIMATE = 0) as LAST_ACTUAL_DATE,
RO.ANOMALIES as READ_EXCEP
from gcgt_re_reading R
join GCGT_ME_DEVICE D on D.id_device = R.id_device
join GCGT_ME_DEVICE_MODEL M on M.ID_MODEL = D.ID_MODEL
join GCGT_ME_DEVICE_MARK DM on DM.ID_MARK = M.ID_MARK
join GCGT_RE_MEASURING_POINT_DEVICE PD on PD.ID_DEVICE = R.ID_DEVICE
join GCCOM_SECTOR_SUPPLY SS on SS.ID_SECTOR_SUPPLY = R.ID_SECTOR_SUPPLY
join GCCOM_CONTRACTED_SERVICE CS on CS.ID_SECTOR_SUPPLY = SS.ID_SECTOR_SUPPLY
join GCCOM_PAYMENT_FORM PF on PF.ID_PAYMENT_FORM = CS.ID_PAYMENT_FORM
left join GCGT_RE_ROUTE RO on RO.ID_ROUTE = R.ID_ROUTE
left join GCGT_RE_ROUTE_MASTER rom on rom.ID_ROUTE_MASTER = RO.ID_ROUTE_MASTER
left join GCGT_RE_ROUTE_SET ROS on ROS.ID_ROUTE_SET = rom.ID_ROUTE_SET
left join GCGT_RE_READING_UNIT ru on ru.ID_RU = ROS.ID_RU
left join GCGT_RE_READER REA on REA.ID_READER = RO.ID_READER
left join GCCOM_READINGS_ITEMSTOBILL r2b on r2b.ID_READING = R.ID_READING
left join GCCOM_ITEMS_TO_BILL i2b on i2b.ID_ITEM_TO_BILL = r2b.ID_READING_ITEM2BILL
left join GCCOM_BILL bill on bill.ID_BILL = i2b.ID_BILL
join GCCOM_CONSUM_TYPE CON on CON.COD_DEVELOP = R.USAGE_TYPE
where CS.STATUS = 'ESTSC00001'
and
((( CONVERT(DATETIME,R.READING_DATE,101)) >= CONVERT(DATETIME,'$P!{Reading_Date_From}',101)) and  (( CONVERT(DATETIME,R.READING_DATE,101)) <= CONVERT(DATETIME,'$P!{Reading_Date_to}',101)))
