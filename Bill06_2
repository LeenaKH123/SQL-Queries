SELECT
	REL.FULL_NAME AS 'CUSTOMER NAME',
	F.REFERENCE AS 'ACCOUNT NUMBER',
	FT.DESCRIPTION AS 'SIGNAL',
	CFT.NAME_TYPE AS 'ACCOUNT TYPE',
	isnull((select top 1 'Y' bulk_acc  from gccom_account_buncher  ba where ba.id_payment_form = f.id_payment_form),'N') AS 'BULK ACCOUNT',
	AD.ADDRESS+' - '+AD.UNIT_NUMBER AS 'Address - Unite number',
	BILL.UPDATE_USER + ' - '+BILL.UPDATE_PROGRAM AS 'Done by User - System',
	BILL.CYCLE_NUMBER AS 'Cycle number',
	BILL.CREATION_DATE As 'Generated date',
	(select 
    GCCOM_SECTOR_SUPPLY.ID_SECTOR_SUPPLY from 
	GCCOM_SECTOR_SUPPLY inner join
	GCCOM_SUPPLY on GCCOM_SUPPLY.ID_SUPPLY = GCCOM_SECTOR_SUPPLY.ID_SUPPLY WHERE GCCOM_SUPPLY.ID_ADDRESS = AD.ID_ADDRESS  ) AS 'SPN',
	( CASE
	       when CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='enero' then 'January'
	       when  CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='febrero' then 'February'
	       when  CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='marzo' then 'March'
	       when CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='abril' then 'April'
	       when CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)= 'mayo' then 'May'
	       when  CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='junio' then 'June'
	       when  CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='julio' then 'July'
	       when CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='agosto' then 'August'
	       when CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='septiembre' then 'September'
	       when  CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='octubre' then 'October'
	       when CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='noviembre' then 'November'
	       when CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)='diciembre' then 'December'
	       ELSE CAST(DATENAME(MONTH,	BILL.BILLING_DATE) AS CHAR)
	   END	
	)AS 'BILLING DATE MONTH',
	
	(
	SELECT
		COUNT(BILL.ID_BILL)
	FROM
		GCCOM_BILL BILL
	INNER JOIN GCCOM_PAYMENT_FORM F ON
		F.ID_PAYMENT_FORM = BILL.ID_PAYMENT_FORM
	WHERE
		F.REFERENCE = '$P!{Enter_Account_Number}'
		AND BILL.BILLING_DATE > '$P!{Date_From}'
		AND BILL.BILLING_DATE < '$P!{Date_To}') AS 'BILL NO IN BILL DATE',
	ISNULL((
	SELECT
		BILL_WAT.PENDING_AMOUNT
	FROM
		GCCOM_BILL BILL_WAT
	INNER JOIN GCCOM_PAYMENT_FORM F ON
		F.ID_PAYMENT_FORM = BILL.ID_PAYMENT_FORM
	WHERE
		F.REFERENCE = '$P!{Enter_Account_Number}'
		AND BILL.ID_OFFERED_SERVICE = 19
		and bill.ID_BILL = bill_wat.ID_BILL),
	0) AS 'WATER AMOUNT',
	ISNULL((
	SELECT
		BILL_ELE.PENDING_AMOUNT
	FROM
		GCCOM_BILL BILL_ELE
	INNER JOIN GCCOM_PAYMENT_FORM F ON
		F.ID_PAYMENT_FORM = BILL.ID_PAYMENT_FORM
	WHERE
		F.REFERENCE = '$P!{Enter_Account_Number}'
		AND BILL.ID_OFFERED_SERVICE = 1
		and bill.ID_BILL = bill_ele.ID_BILL),
	0) AS 'ELECTRICITY',
	BILL.EXCHANGE_RATE AS 'RATE',
	BILL.TOTAL_AMOUNT AS 'TOTAL',
	BILL.NOTTAXBILL_AMOUNT AS 'PAYMENTS',
	NULL AS 'OTHER TRANSACTION',
	OUC_REPORT.I18N_JASPER('$P!{Language}',BS.NAME_TYPE_XI18N,BS.NAME_TYPE) AS 'BILL STATE',
			(
	SELECT
		TOP 1 gb.BILLING_DATE
	FROM
		GCCOM_BILL gb
	inner join GCCOM_CONTRACTED_SERVICE cs ON
		cs.ID_CONTRACTED_SERVICE = gb.ID_CONTRACTED_SERVICE
	WHERE
		gb.id_payment_form = f.ID_PAYMENT_FORM
		AND cs.ID_OFFERED_SERVICE = 10000000001
	order by
		gb.BILLING_DATE DESC
) as Last_Billed_Rent,
	(
	SELECT
		SUM(gb.PENDING_AMOUNT)
	FROM
		GCCOM_BILL gb
	inner join GCCOM_CONTRACTED_SERVICE cs ON
		cs.ID_CONTRACTED_SERVICE = gb.ID_CONTRACTED_SERVICE
	WHERE
		gb.id_payment_form = f.ID_PAYMENT_FORM
		
		AND gb.COLLECTION_STATUS IS NOT NULL
) as Outstanding_Rent
FROM
	GCCOM_BILL BILL
INNER JOIN GCCOM_PAYMENT_FORM F ON
	F.ID_PAYMENT_FORM = BILL.ID_PAYMENT_FORM
INNER JOIN GCCD_RELATIONSHIP REL ON
	F.ID_CUSTOMER = REL.ID_RELATIONSHIP
INNER JOIN GCCOM_PAYMENT_FORM_TYPE FT ON
	FT.COD_DEVELOP = F.COD_TYPE
INNER JOIN GCCOM_COLLECTION_FORM_TYPE CFT ON
	CFT.COD_DEVELOP = F.COLLECTION_FORM_TYPE
INNER JOIN GCCOM_BILL_STATUS BS ON
	BS.COD_DEVELOP = BILL.BILLING_STATUS
INNER JOIN GCCOM_ADDRESS AD ON
	AD.ID_ADDRESS = REL.ID_ADDRESS
WHERE
	F.REFERENCE = '$P!{Enter_Account_Number}'
	AND BILL.BILLING_DATE > '$P!{Date_From}'
	AND BILL.BILLING_DATE < '$P!{Date_To}'
