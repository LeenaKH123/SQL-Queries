WITH temp_table as (
SELECT
	CASE
		WHEN (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) ) < 91 then 'A1 - <= 90 Days'
		WHEN 90 < (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )
		and (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) ) < 181 then 'A2 - Between 91 and 180 Days'
		WHEN 180 < (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )
		and (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )< 271 then 'A3 - Between 181 and 270 Days'
		WHEN 270 < (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )
		and (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )< 361 then 'A4 - Between 271 and 300 Days'
		WHEN 360 < (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )
		and (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )< 721 then 'A5 - Between 361 and 720 Days'
		WHEN 720 < (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )
		and (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) )< 1081 then 'A6 - Between 721 and 1080 Days'
		WHEN (DATEDIFF(day, B.BILLING_DATE, CURRENT_TIMESTAMP) ) > 1080 then 'A7 - > 1080 Days'
	END as Age,
	B.PENDING_AMOUNT as Calc,
	B.ID_OFFERED_SERVICE as ID_OFFERED_SERVICE 
	from
		GCCOM_BILL as B 	
		INNER JOIN GCCOM_CONTRACTED_SERVICE CS ON B.ID_CONTRACTED_SERVICE = CS.ID_CONTRACTED_SERVICE
	WHERE CS.ID_OFFERED_SERVICE in (10000000001,176) 
	AND B.PENDING_AMOUNT > 0
		)
		Select Age,
		COALESCE((select sum (calc) from temp_table as tt1 where tt1.ID_OFFERED_SERVICE = 10000000001 and tt1.Age = TT3.Age) ,0) as  Rent,
		COALESCE((select sum (calc) from temp_table as tt2 where tt2.ID_OFFERED_SERVICE = 176 and tt2.Age = TT3.Age) ,0) as  Rate		
		from temp_table	TT3
		Group by TT3.Age
		Order by TT3.Age
