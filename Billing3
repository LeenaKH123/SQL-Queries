SELECT 	gr.FULL_NAME 				as Customer_Name,
		pf.REFERENCE 				as Account,
		pfb.REFERENCE				as Bulk_Account,
		pft.DESCRIPTION				as Signal,
		gb.BILLING_DATE 			as Billing_Date, 			
		OUC_REPORT.I18N_JASPER('$P!{Language}', bs.NAME_TYPE_XI18N, bs.NAME_TYPE) as Bill_Status,
		CASE 
			WHEN cs.ID_OFFERED_SERVICE = 19 THEN gb.TOTAL_AMOUNT
			ELSE NULL
		END							as Water_BD,
		CASE 
			WHEN cs.ID_OFFERED_SERVICE = 1 THEN gb.TOTAL_AMOUNT
			ELSE NULL
		END							as Elect_BD,
		CASE 
			WHEN cs.ID_OFFERED_SERVICE = 10000000001 THEN gb.TOTAL_AMOUNT
			ELSE NULL
		END							as Rent_BD,
		CASE 
			WHEN cs.ID_OFFERED_SERVICE = 176 THEN gb.TOTAL_AMOUNT
			ELSE NULL
		END							as Rate_BD,
		gb.TOTAL_AMOUNT				as Total_BD,
		gb.TOTAL_AMOUNT - gb.PENDING_AMOUNT		as Payments_BD
FROM GCCOM_PAYMENT_FORM pf
	INNER JOIN GCCD_RELATIONSHIP gr ON pf.ID_CUSTOMER =  gr.ID_RELATIONSHIP
	LEFT JOIN GCCOM_ACCOUNT_BUNCHER ab 
		INNER JOIN GCCOM_PAYMENT_FORM pfb ON pfb.ID_PAYMENT_FORM = ab.ID_PAYMENT_FORM_BUNCHER
	ON pf.ID_PAYMENT_FORM = ab.ID_PAYMENT_FORM AND ab.END_DATE IS NULL
	INNER JOIN GCCOM_PAYMENT_FORM_TYPE pft ON pf.COD_TYPE = pft.COD_DEVELOP
	LEFT JOIN GCCOM_BILL gb 
		INNER JOIN GCCOM_BILL_STATUS bs ON gb.BILLING_STATUS = bs.COD_DEVELOP
		INNER JOIN GCCOM_CONTRACTED_SERVICE cs ON gb.ID_CONTRACTED_SERVICE = cs.ID_CONTRACTED_SERVICE 
		LEFT JOIN GCACC_BILLING_DOC bd ON bd.ID_ORIG_BILL = gb.ID_BILL
	ON pf.ID_PAYMENT_FORM = gb.ID_PAYMENT_FORM
WHERE 	(pf.REFERENCE = '$P!{AccountID}' or '$P!{AccountID}' = '-999') 
	AND (('$P!{Date_From}' IS NULL) OR (gb.DISPATCH_COLL_DATE >= CONVERT(DATETIME, '$P!{Date_From}', 101)))
	AND (('$P!{Date_To}' IS NULL) OR (gb.DISPATCH_COLL_DATE <= CONVERT(DATETIME, '$P!{Date_To}', 101)))
	AND bd.ID_ORIG_BILL IS NULL
	AND gb.BILLING_TYPE <> 'TIPFAC0011'
	AND gb.BILLING_STATUS <> 'ESTFAC0007'
ORDER BY gb.BILLING_DATE
