WITH DEBT_ACC (ID_PAYMENT_FORM, ID_SECTOR, PENDING_AMOUNT, EXPIRATION_DATE) as (
					SELECT GB.ID_PAYMENT_FORM, GSS.ID_SECTOR, GB.PENDING_AMOUNT, GB.EXPIRATION_DATE FROM GCCOM_BILL GB
					  INNER JOIN GCCOM_CONTRACTED_SERVICE GCS ON GCS.ID_CONTRACTED_SERVICE = GB.ID_CONTRACTED_SERVICE
					  INNER JOIN GCCOM_SECTOR_SUPPLY GSS ON GSS.ID_SECTOR_SUPPLY = GCS.ID_SECTOR_SUPPLY
				)
				SELECT O.COD_OFFICE as OFFICE_CODE,
				       O.OFFICE_NAME as OFFICE_NAME,
				       RSC.RSC_CODE + ' ' + RSC.RSC_CODE_DESC as RSC_DESCRIPTION,
				       RSC.RSC_CODE as RSC_CODE,
				       R.COD_CUSTOMER as CUSTOMER_CODE,
				       R.CUSTOMER_NAME as CUSTOMER_NAME,
				       R.SURNAME_1 as SURNAME_1,
				       R.MIDDLE_NAME as SURNAME_2,
				       R.SURNAME_2 as SURNAME_3,
				       R.CUSTOMER_NAME_LOCAL as CUSTOMER_NAME_ARABIC,
				       R.SURNAME_1_LOCAL as SURNAME_1_ARABIC,
				       R.MIDDLE_NAME as SURNAME_2_ARABIC,
				       R.SURNAME_2 as SURNAME_3_ARABIC,
				       OUC_REPORT.I18N_JASPER('$P!{Language}', GC.NAME_TYPE_XI18N, GC.NAME_TYPE) as NATIONALITY,
				       R.DOC_NUMBER as DOCUMENT_ID,
				       OUC_REPORT.I18N_JASPER('$P!{Language}', PDT.NAME_TYPE_XI18N, PDT.NAME_TYPE) as DOCUMENT_TYPE,
				       R.TELEPHONE1 as TELEPHONE,
				       R.EMAIL1 as EMAIL,
					   OUC_REPORT.I18N_JASPER('$P!{Language}', CV.NAME_TYPE_XI18N, CV.NAME_TYPE) as MEDIA,
				       PF.REFERENCE as ACCOUNT_NUMBER,
				       SS.NISS as SECTOR_SUPPLY,
					   OUC_REPORT.I18N_JASPER('$P!{Language}', S.NAME_TYPE_XI18N, S.NAME_TYPE) as RSC_E_W_R,
				       OUC_REPORT.I18N_JASPER('$P!{Language}', SEC.NAME_TYPE_XI18N, SEC.NAME_TYPE) as SECTOR,
				       PFT.DESCRIPTION as SIGNAL,
				       CASE WHEN F.IND_SUBSIDY = 1 THEN 'Yes' ELSE 'No' END as SUBSIDIZED,
				       A.ADDRESS as ADDRESS,
				       A.ADDRESS as ADDRESS_A,
				       A.NAS_CODE as NAS_CODE,
				       GE2.ENTITY_NAME as GOVERNORATE,
					   OUC_REPORT.I18N_JASPER('$P!{Language}', PT.NAME_TYPE_XI18N, PT.NAME_TYPE) as SUPPLY_TYPE,				  
					   OUC_REPORT.I18N_JASPER('$P!{Language}', SRT.NAME_TYPE_XI18N, SRT.NAME_TYPE) as SERVICE_RATE_TYPE,				   
				       AV.NAME_TYPE as SERVICE_SIZE,
				       CS.NISC as CONTRACT_NUMBER,
					   OUC_REPORT.I18N_JASPER('$P!{Language}', CSS.NAME_TYPE_XI18N, CSS.NAME_TYPE) as CONTRACT_STATUS,				    
				       MD.SERIAL_NUM as METER_NUMBER,
				       MDK.MARK_NAME as METER_BRAND,
				       IsNull((SELECT SUM(PENDING_AMOUNT) FROM DEBT_ACC DA WHERE DA.ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM AND DA.ID_SECTOR = SS.ID_SECTOR), 0) as SERVICE_OUTSTANDING,
				       IsNull((SELECT SUM(PENDING_AMOUNT) FROM DEBT_ACC DA WHERE DA.ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM), 0) as TOTAL_OUTSTANDING,
				       IsNull((SELECT SUM(PENDING_AMOUNT) FROM DEBT_ACC DA WHERE DA.ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM AND DA.EXPIRATION_DATE < getDate()), 0) as DUE_DEBT,
				       LAST_BILL.BILL_NUMBER as LAST_BILL,
					   OUC_REPORT.I18N_JASPER('$P!{Language}', BST.NAME_TYPE_XI18N, BST.NAME_TYPE) as LAST_BILL_STATUS,
				   
				       (SELECT LBP.BILL_NUMBER FROM GCCOM_BILL LBP WHERE LBP.ID_BILL = (SELECT SUBSTRING(temp.LAST_BILL_PAY_DATA, 9, 15)
				                                                                          FROM (SELECT MAX(CONCAT(CONVERT(VARCHAR(8), BILLING_DATE, 112), ID_BILL)) LAST_BILL_PAY_DATA
				                                                                                  FROM GCCOM_BILL
				                                                                                  WHERE ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM 
				                                                                                    AND TOTAL_AMOUNT > PENDING_AMOUNT) temp) ) as LAST_BILL_PAY,
				       LAST_PAY.COLLECTION_AMOUNT as LAST_PAYMENT_AMOUNT,
				       LAST_PAY.COLLECTION_DATE as LAST_PAYMENT_DATE,
				       (SELECT count(DISTINCT NC.ID_NOTICE) FROM GCCB_NOTICE_COMPOSITION NC 
				         INNER JOIN GCCB_NOTICE N ON NC.ID_NOTICE = N.ID_NOTICE 
				         WHERE NC.COLOUR_BILL = 1 AND N.ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM) as RED_BILLS,
					  OUC_REPORT.I18N_JASPER('$P!{Language}', CFT.NAME_TYPE_XI18N, CFT.NAME_TYPE) as DDI_PDC_CMAX,				        
				       IsNull((SELECT SUM(BD.PENDING_AMOUNT) FROM GCCOM_BILL BD WHERE BD.ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM AND BD.BILL_TYPE = 'TFGEN10006'), 0) as DEPOSIT_BALANCE,
				       E.NAME as STAFF_NAME,
				       OFFICE.OFFICE_NAME as RESPONSIBLE_OFFICE_NAME,
				       SR.CREATION_SR_DATE as REGISTRATION_DATE,
					   OUC_REPORT.I18N_JASPER('$P!{Language}', CV.NAME_TYPE_XI18N, CV.NAME_TYPE) as PREFFERED_MEDIA,				  
					   OUC_REPORT.I18N_JASPER('$P!{Language}', CH.NAME_TYPE_XI18N, CH.NAME_TYPE) as PREFFERED_CHANNEL				      
				  FROM GCCD_RELATIONSHIP R
				  INNER JOIN GCCOM_PAYMENT_FORM PF ON PF.ID_CUSTOMER = R.ID_RELATIONSHIP
				    INNER JOIN GCCB_OFFICE O ON O.ID_OFFICE = PF.ID_OFFICE
				    LEFT JOIN GCCOM_PAYMENT_FORM_TYPE PFT ON PFT.COD_DEVELOP = PF.COD_TYPE
				    LEFT JOIN GCCOM_COLLECTION_FORM_TYPE CFT ON CFT.COD_DEVELOP = PF.COLLECTION_FORM_TYPE
				  INNER JOIN GCCOM_GEO_COUNTRY GC ON GC.ID_GEO_COUNTRY = R.NATIONALITY
				  INNER JOIN GCCOM_PERSONAL_DOCUMENT_TYPE PDT ON PDT.COD_DEVELOP = R.DOC_TYPE
				  INNER JOIN GCCOM_CONTRACTED_SERVICE CS
				    INNER JOIN GCCOM_CONTRACT_SERV_STATUS CSS ON CSS.COD_DEVELOP = CS.STATUS
				    LEFT JOIN GCCOM_BILLING_SERVICE BS ON BS.ID_CONTRACTED_SERVICE = CS.ID_CONTRACTED_SERVICE
				    LEFT JOIN GCCOM_FARE F ON F.ID_FARE = BS.ID_FARE
				  ON CS.ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM
				  INNER JOIN GCCOM_CONTRACT C ON C.ID_CONTRACT = CS.ID_CONTRACT
				  INNER JOIN GCCOM_SECTOR_SUPPLY SS
				    LEFT JOIN GCCOM_SEGMENT S ON S.ID_SEGMENT = SS.ID_BILLING_CLASS
				    INNER JOIN GCCOM_SECTOR SEC ON SEC.ID_SECTOR = SS.ID_SECTOR
				    INNER JOIN GCCOM_SERVICE_RATE_TYPE SRT ON SRT.COD_DEVELOP = SS.SERVICE_RATE_TYPE
				    LEFT JOIN GCGT_ATTRIBUTE ATT
					  LEFT JOIN GCGT_ATTRIBUTE_VALUES AV ON AV.COD_DEVELOP = ATT.VALUE
					ON ATT.ID_SECTOR_SUPPLY = SS.ID_SECTOR_SUPPLY AND ATT.COD_ATTRIBUTE IN ('METCAL', 'ELEATTCPH')
				  ON SS.ID_SECTOR_SUPPLY = CS.ID_SECTOR_SUPPLY
				  INNER JOIN GCCOM_SUPPLY SUP
				    LEFT JOIN GCCOM_PLACE_TYPE PT ON PT.COD_DEVELOP = SUP.PLACE_TYPE
				  ON SUP.ID_SUPPLY = SS.ID_SUPPLY
				  INNER JOIN GCCOM_ADDRESS A ON A.ID_ADDRESS = SUP.ID_ADDRESS
				  INNER JOIN GCCOM_GEOGRAPHIC_ENTITY GE1 ON GE1.ID_GEO_ENTITY = A.ID_GEO_ENTITY
				  INNER JOIN GCCOM_GEOGRAPHIC_ENTITY GE2 ON GE2.ID_GEO_ENTITY = GE1.ID_GEO_ENTITY_P
				  LEFT JOIN GCCC_CHANNEL CH ON CH.COD_DEVELOP = R.PREF_CHANNEL
				  LEFT JOIN GCCC_COMMUNICATION_VIA CV ON CV.COD_DEVELOP = R.PREF_VIA
				  LEFT JOIN GCGT_RE_MEASUREMENT_POINT MP
				    LEFT JOIN GCGT_ME_DEVICE MD
				      INNER JOIN GCGT_ME_DEVICE_MODEL MDM 
				        INNER JOIN GCGT_ME_DEVICE_MARK MDK ON MDK.ID_MARK = MDM.ID_MARK
				      ON MDM.ID_MODEL = MD.ID_MODEL
				    ON MD.ID_DEVICE = MP.ID_METER
				  ON MP.ID_SECTOR_SUPPLY = SS.ID_SECTOR_SUPPLY 
				  LEFT JOIN GCCOM_RSCODE_CONFIGURATION RSC
				    ON RSC.ID_SEGMENT = CS.BILLING_CLASS
				   AND RSC.ID_SECTOR = SS.ID_SECTOR
				   AND RSC.EXCEPTIONAL_TARIFF = CS.COD_EXCTARIFF
				   AND IsNull(RSC.NATIONALITY, -1) = CASE WHEN EXISTS (SELECT 1 FROM GCCOM_RSCODE_CONFIGURATION WHERE ID_SEGMENT = CS.BILLING_CLASS AND ID_SECTOR = SS.ID_SECTOR AND EXCEPTIONAL_TARIFF = CS.COD_EXCTARIFF AND NATIONALITY = R.NATIONALITY) THEN R.NATIONALITY ELSE -1 END /*Bahreini or non-Bahreini*/
				  LEFT JOIN GCCOM_BILL LAST_BILL   ON LAST_BILL.ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM AND LAST_BILL.ID_BILL = (SELECT SUBSTRING(temp.LAST_BILL_DATA, 9, 15)
				                                                                               FROM (SELECT MAX(CONCAT(CONVERT(VARCHAR(8), BILLING_DATE, 112), ID_BILL)) LAST_BILL_DATA
				                                                                                       FROM GCCOM_BILL
				                                                                                      WHERE ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM) temp)
				    LEFT JOIN GCCOM_BILL_STATUS BST ON BST.COD_DEVELOP = LAST_BILL.BILLING_STATUS
				  LEFT JOIN GCCB_ONLINE_COLLECTION LAST_PAY ON LAST_PAY.ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM AND LAST_PAY.ID_ONLINE_COLLECTION = (SELECT SUBSTRING(temp.LAST_PAY_DATA, 9, 15)
				                                                                                                                                     FROM (SELECT MAX(CONCAT(CONVERT(VARCHAR(8), COLLECTION_DATE, 112), ID_ONLINE_COLLECTION)) LAST_PAY_DATA
				                                                                                                                                             FROM GCCB_ONLINE_COLLECTION
				                                                                                                                                            WHERE ID_PAYMENT_FORM = PF.ID_PAYMENT_FORM) temp)
				  LEFT JOIN GCCOM_SERVICE_REQUEST SR
				    LEFT JOIN GCGT_WF_ENTITY_RESPONSIBLE WER ON WER.ID_ENTITY_RESPONSIBLE = SR.ID_RESPONSIBLE
				    LEFT JOIN GCCB_EMPLOYEE E ON E.ID_EMPLOYEE_CB = WER.ID_EMPLOYEE
				    LEFT JOIN GCCB_OFFICE OFFICE ON OFFICE.ID_OFFICE = WER.ID_OFFICE
				  ON SR.ID_ACCOUNT = PF.ID_PAYMENT_FORM AND SERVREQ_TYPE = 'SREQTYP001'
				
	WHERE C.FROM_DATE <= EOMONTH(convert(date, right($P{Accounting_Period}, 4) + left($P{Accounting_Period}, 2) + '01', 112)) 
					   AND C.END_DATE  >=         convert(date, right($P{Accounting_Period}, 4) + left($P{Accounting_Period}, 2) + '01', 112)
				 AND ($P{BillingRsCode} = '(All)' OR RSC.RSC_CODE = $P{BillingRsCode})
				 AND ($P{Customer_Type} = '-999' OR R.CUSTOMER_TYPE = $P{Customer_Type})
				 AND ($P{BillingPropertyType} = '(All)' OR SUP.PLACE_TYPE = $P{BillingPropertyType})
				  AND ($P{Service_Rate_Type} = '-999' OR SS.SERVICE_RATE_TYPE = $P{Service_Rate_Type})
				   AND ($P{BillingDocument} = '(All)' OR R.DOC_TYPE = $P{BillingDocument})
				   AND ($P{Customer_Document_Number} is null OR $P{Customer_Document_Number} = '' OR R.DOC_NUMBER = $P{Customer_Document_Number})
				    AND ($P{Payment_Form_Type} = '-999' OR PF.COD_TYPE = $P{Payment_Form_Type})
				     AND ($P{BlockR} = '-999' or GE1.ID_GEO_ENTITY = $P{BlockR})
				     AND ($P{GovernorateR} = '(All)' or GE2.ID_GEO_ENTITY = $P{GovernorateR})
				      AND ($P{Subsidized} = IsNull(F.IND_SUBSIDY,0))
                     AND ($P{VIP_Profile} = IsNull(PFT.IND_VIP, 0))
                        AND (SELECT MAX(READING_DATE)
          FROM GCGT_RE_READING R1
         WHERE R1.ID_SECTOR_SUPPLY = SS.ID_SECTOR_SUPPLY
           AND R1.ID_MEASURING_POINT = MP.ID_MEASURING_POINT
           AND R1.ID_DEVICE = MD.ID_DEVICE
           AND R1.USAGE_TYPE IN ('TPCONS0001','TPCONS0006')) BETWEEN $P{Date_From} AND $P{Date_To}  
